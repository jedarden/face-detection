name: ğŸ”’ Security Scan

on:
  push:
    branches:
      - main
    paths:
      - 'docker-app/**'
  pull_request:
    branches:
      - main
    paths:
      - 'docker-app/**'
  schedule:
    - cron: '0 2 * * 1' # Weekly scan on Mondays at 2 AM UTC

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  security-scan:
    runs-on: apexalgo-iad-runners
    permissions:
      contents: read
      security-events: write

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Build Docker image for scanning
      uses: docker/build-push-action@v5
      with:
        context: ./docker-app
        file: ./docker-app/Dockerfile
        push: false
        tags: face-detection-security-scan:latest
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: face-detection-security-scan:latest
        format: sarif
        output: trivy-results.sarif

    - name: ğŸ“Š Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: trivy-results.sarif

    - name: ğŸ”’ Run Docker security scan
      run: |
        echo "ğŸ” Running Docker security best practices scan..."
        
        # Check for security best practices
        docker run --rm -i hadolint/hadolint < docker-app/Dockerfile || true
        
        # Export the image to a tar file for Trivy to scan
        docker save face-detection-security-scan:latest -o image.tar
        
        # Check for known vulnerabilities using the tar file
        docker run --rm -v $PWD:/workspace aquasec/trivy:latest image \
          --severity HIGH,CRITICAL \
          --input /workspace/image.tar
        
        # Clean up
        rm -f image.tar
        
        echo "âœ… Security scan completed!"

    - name: ğŸ“‹ Generate security summary
      run: |
        echo "## ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** \`$(date -u)\`" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`face-detection-security-scan:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ›¡ï¸ Security Measures:" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”’ Non-root user execution" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸš« No sensitive data in image" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” Secure headers configured" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ›¡ï¸ Regular vulnerability scanning" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“‹ SARIF results uploaded to Security tab" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Scan Coverage:" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ” Base image vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ Package vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ³ Dockerfile best practices" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”’ Security configuration" >> $GITHUB_STEP_SUMMARY